<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palbonus | Telegram Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAd8fquXNqBsz-KZalksvgK_QGGtd_T1U",
            authDomain: "palbonus-fd779.firebaseapp.com",
            projectId: "palbonus-fd779",
            storageBucket: "palbonus-fd779.firebasestorage.app",
            messagingSenderId: "840105888876",
            appId: "1:840105888876:web:e139aa7f90837410ce9c49"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        tg.expand(); // Saytı tam ekran edir

        async function initApp() {
            const user = tg.initDataUnsafe?.user || { id: "test_user", first_name: "Qonaq" };
            const userRef = doc(db, "users", user.id.toString());
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                await setDoc(userRef, {
                    name: user.first_name,
                    balance: 0,
                    id: user.id
                });
                renderUI(user.id, user.first_name, 0);
            } else {
                const data = userSnap.data();
                renderUI(user.id, data.name, data.balance);
            }
        }

        function renderUI(id, name, balance) {
            document.getElementById('userName').innerText = name;
            document.getElementById('userId').innerText = `ID: ${id}`;
            document.getElementById('userBalance').innerText = balance.toFixed(2);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        window.claimBonus = async () => {
            const user = tg.initDataUnsafe?.user || { id: "test_user" };
            const userRef = doc(db, "users", user.id.toString());
            await updateDoc(userRef, { balance: increment(10) });
            
            const newSnap = await getDoc(userRef);
            document.getElementById('userBalance').innerText = newSnap.data().balance.toFixed(2);
            alert("Təbriklər! +10 PLC balansınıza əlavə edildi.");
        };

        initApp();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body { background: #0b0f1a; color: white; font-family: 'Poppins', sans-serif; }
        .gold-glow { box-shadow: 0 0 25px rgba(245, 158, 11, 0.2); }
        .coin-spin { animation: rotate 5s linear infinite; }
        @keyframes rotate { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div id="loading" class="text-yellow-500 font-bold animate-pulse">YÜKLƏNİR...</div>

    <div id="app" class="hidden w-full max-w-md">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-yellow-500 tracking-widest" style="font-family: 'Orbitron';">PALBONUS</h1>
            <div id="userId" class="bg-slate-800 px-4 py-1 rounded-full text-xs text-slate-400 border border-slate-700"></div>
        </div>

        <div class="bg-slate-900/50 border border-yellow-500/20 p-8 rounded-[3rem] text-center gold-glow mb-6">
            <div class="w-20 h-20 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4 coin-spin shadow-lg shadow-yellow-500/50">
                <span class="text-4xl font-bold text-black">P</span>
            </div>
            <p class="text-slate-400 text-sm">Xoş gəldin, <span id="userName" class="text-white font-semibold"></span></p>
            <div class="text-5xl font-bold mt-2"><span id="userBalance">0</span> <span class="text-lg text-yellow-500">PLC</span></div>
        </div>

        <button onclick="claimBonus()" class="w-full bg-yellow-500 text-black font-bold py-4 rounded-2xl hover:bg-yellow-400 active:scale-95 transition-all mb-4">GÜNDƏLİK BONUSU AL (+10)</button>
    </div>

</body>
</html>
